<!DOCTYPE html>
<html>
<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Display Manager</title>
    <link rel="stylesheet" href="/displayManager.css">
    <!-- <script src="/fsManager.js"></script> -->
    <script>
        let ws;
        let pages = {};
        

        function connect() {
            ws = new WebSocket('ws://' + window.location.hostname + ':81');

            ws.onopen = () => {
                // Send pageLoaded signal
                ws.send(JSON.stringify({
                    type: 'pageLoaded'
                }));
            };

            ws.addEventListener('message', (event) => {
              try {
                    const data = JSON.parse(event.data);

                    // Unified Event Handling
                    if (data.event === 'includeJsScript') {
                        console.log(`addEventListener(): includeJsScript: [${data.data}]`);
                        handleEvent('includeJsScript', data.data);
                        return;
                    }
                    if (data.event === 'callJsFunction') {
                        //console.log('addEventListener(): callJsFunction:', data.data);
                        handleEvent('callJsFunction', data.data);
                        return;
                    }
                    // Handle Redirect
                    if (data.type === 'redirect') {
                        window.location.href = data.url;
                        return;
                    }

                    // Handle Partial Update
                    if (data.type === 'update') {
                        const target = document.getElementById(data.target);
                        if (target) {
                            if (data.target === 'bodyContent') {
                                target.innerHTML = data.content;
                            } else if (target.tagName === 'INPUT') {
                                target.value = data.content;
                            } else {
                                target.textContent = data.content;
                            }
                        }
                        return;
                    }

                    // Handle Full State Update
                    const bodyContent = document.getElementById('bodyContent');
                    bodyContent.innerHTML = data.body || '';
                    bodyContent.style.display = data.isVisible ? 'block' : 'none';

                    // Efficient Input Listener Addition
                    document.querySelectorAll('input[id]').forEach(input => {
                        if (!input.hasInputListener) {
                            input.addEventListener('input', () => {
                                ws.send(JSON.stringify({
                                    type: 'inputChange',
                                    placeholder: input.id,
                                    value: input.value
                                }));
                            });
                            input.hasInputListener = true;
                        }
                    });

                    // Dynamic Menu Rendering
                    const menuContainer = document.querySelector('.dM_left');
                    menuContainer.innerHTML = '';
                    if (data.menus && data.menus.length > 0) {
                        data.menus.forEach(menu => {
                            const menuDiv = document.createElement('div');
                            menuDiv.className = 'dM_dropdown';
                            const menuSpan = document.createElement('span');
                            menuSpan.textContent = menu.name;
                            menuDiv.appendChild(menuSpan);

                            const menuList = document.createElement('ul');
                            menuList.className = 'dM_dropdown-menu';
                            menu.items.forEach(item => {
                                const li = document.createElement('li');
                                if (item.disabled) li.className = 'disabled';
                                const link = document.createElement(item.url ? 'a' : 'span');
                                link.textContent = item.name;
                                if (item.url) link.href = item.url;
                                if (!item.disabled && !item.url) {
                                    link.onclick = () => handleMenuClick(menu.name, item.name);
                                }
                                li.appendChild(link);
                                menuList.appendChild(li);
                            });
                            menuDiv.appendChild(menuList);
                            menuContainer.appendChild(menuDiv);
                        });
                    }

                    // Message Handling and Timed Removal
                    const msg = document.getElementById('message');
                    if (window.messageTimer) {
                        clearTimeout(window.messageTimer);
                        window.messageTimer = null;
                    }
                    msg.textContent = data.message || '';
                    msg.className = data.message ? (data.isError ? 'error-message' : 'normal-message') : '';
                    if (data.message && data.messageDuration > 0) {
                        window.messageTimer = setTimeout(() => {
                            msg.textContent = '';
                            msg.className = '';
                            window.messageTimer = null;
                        }, data.messageDuration);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            });

            ws.onclose = () => setTimeout(connect, 1000);
        } // connect()connect()


        let scriptLoadPromises = {};  // Track script load status

        function handleEvent(eventType, data) {
            console.log('handleEvent() called with:', eventType, data);
            switch (eventType) {
              case 'callJsFunction':
                    console.log('Handling callJsFunction:', data);
                    // Check if we're waiting for any scripts to load
                    const pendingScripts = Object.values(scriptLoadPromises);
                    if (pendingScripts.length > 0) {
                        // Wait for all scripts to load before calling the function
                        Promise.all(pendingScripts).then(() => {
                            if (typeof window[data] === 'function') {
                                console.log('handleEvent(): Calling function:', data);
                                window[data]();
                                // Send success feedback
                                ws.send(JSON.stringify({
                                    type: 'jsFunctionResult',
                                    functionName: data,
                                    success: true
                                }));
                            } else {
                                console.warn('[' + data + '] does not exist or is not a function');
                                // Send failure feedback
                                ws.send(JSON.stringify({
                                    type: 'jsFunctionResult',
                                    functionName: data,
                                    success: false
                                }));
                            }
                        });
                    } else {
                        // No pending scripts, call function immediately
                        if (typeof window[data] === 'function') {
                            console.log('handleEvent(): Calling function:', data);
                            window[data]();
                            // Send success feedback
                            ws.send(JSON.stringify({
                                type: 'jsFunctionResult',
                                functionName: data,
                                success: true
                            }));
                        } else {
                            console.warn('[' + data + '] does not exist or is not a function');
                            // Send failure feedback
                            ws.send(JSON.stringify({
                                type: 'jsFunctionResult',
                                functionName: data,
                                success: false
                            }));
                        }
                    }
                    break;
                case 'includeJsScript':
                    console.log('Handling includeJsScript:', data);
                    // Create a promise for this script load
                    scriptLoadPromises[data] = new Promise((resolve) => {
                        const script = document.createElement('script');
                        script.src = data;
                        script.onload = () => {
                            console.log(`Script [${data}] loaded`);
                            delete scriptLoadPromises[data];  // Clean up
                            resolve();
                        };
                        document.body.appendChild(script);
                    });
                    break;
                default:
                    console.warn('Unhandled event type:', eventType);
            }
      } // handleEvent()


      function enableMenuItem(pageName, menuName, itemName) {
          const menuItems = document.querySelectorAll(`[data-menu="${menuName}"][data-item="${itemName}"]`);
          menuItems.forEach(item => {
              const li = item.parentElement;
              li.classList.remove('disabled');
              if (item.tagName === 'A') {
                  item.style.pointerEvents = '';
              } else {
                  item.onclick = () => handleMenuClick(menuName, itemName);
              }
          });
      }

      function disableMenuItem(pageName, menuName, itemName) {
          const menuItems = document.querySelectorAll(`[data-menu="${menuName}"][data-item="${itemName}"]`);
          menuItems.forEach(item => {
              const li = item.parentElement;
              li.classList.add('disabled');
              if (item.tagName === 'A') {
                  item.style.pointerEvents = 'none';
              } else {
                  item.onclick = null;
              }
          });
      }

      function setPlaceholder(pageName, placeholder, value) {
          const element = document.getElementById(placeholder);
          if (element) {
              if (element.tagName === 'INPUT') {
                  element.value = value;
                  // Add input event listener if not already added
                  if (!element.hasInputListener) {
                      element.addEventListener('input', () => {
                          ws.send(JSON.stringify({
                              type: 'inputChange',
                              placeholder: placeholder,
                              value: element.value
                          }));
                      });
                      element.hasInputListener = true;
                  }
              } else {
                  element.textContent = value;
              }
          }
      }

      function activatePage(pageName) {
          if (pages[pageName]) {
              const bodyContent = document.getElementById('bodyContent');
              bodyContent.innerHTML = pages[pageName];
              bodyContent.style.display = 'block';
              
              // Add input listeners to all input fields
              document.querySelectorAll('input[id]').forEach(input => {
                  if (!input.hasInputListener) {
                      input.addEventListener('input', () => {
                          ws.send(JSON.stringify({
                              type: 'inputChange',
                              placeholder: input.id,
                              value: input.value
                          }));
                      });
                      input.hasInputListener = true;
                  }
              });
          }
      }


      function setMessage(message, duration, isError = false) {
          const msg = document.getElementById('message');
          if (window.messageTimer) {
              clearTimeout(window.messageTimer);
              window.messageTimer = null;
          }
          
          msg.textContent = message;
          msg.className = isError ? 'error-message' : 'normal-message';
          
          if (duration > 0) {
              window.messageTimer = setTimeout(() => {
                  msg.textContent = '';
                  msg.className = '';
                  window.messageTimer = null;
              }, duration * 1000);
          }
      }
      
      function updateDateTime() {
          const now = new Date();
          const options = {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
          };
          document.getElementById('datetime').textContent = 
              now.toLocaleString('nl-NL', options).replace(',', '');
      }

      window.onload = function() {
          connect();
          updateDateTime();
          setInterval(updateDateTime, 1000);
      };
      
      function handleMenuClick(menuName, itemName) {
          ws.send(JSON.stringify({
              type: 'menuClick',
              menu: menuName,
              item: itemName
          }));
      }
      function includeJsScript(fileName) {
        return new Promise((resolve, reject) => {
          // Check if the script is already included to avoid duplicates
          if (!document.querySelector(`script[src="${fileName}"]`)) {
              const script = document.createElement("script");
              script.src = fileName;
              script.async = false;  // Make it synchronous
              script.defer = false;  // Ensure immediate execution
              
              script.onload = () => {
                console.log(`Script [${fileName}] loaded and executed`);
                resolve();
              };
              
              script.onerror = () => {
                console.error(`Failed to load script [${fileName}]`);
                reject();
              };
              
              // Insert at the head to ensure it loads before other scripts
              document.head.appendChild(script);
              console.log(`Including JS script: [${fileName}]`);
          } else {
              console.log(`Script [${fileName}] is already included.`);
              resolve();
          }
        });
      }

      window.mainMessage = function() {
        console.log('main.html(): This is a log message');
        console.log('main.html(): So is this');
        console.error('main.html(): This is an error message');
        console.warn('main.html(): This is a warning message');
        console.log('main.html(): And this');
      }

    </script>
</head>
<body class="dM_body">
    <header class="dM_header">
        <div class="dM_left">
            <!-- Menu will be dynamically inserted here -->
        </div>
        <div class="dM_middle" id="title" style="flex: 1; text-align: center;">Display Manager Demo</div>
        <div class="dM_right" id="datetime"></div>
    </header>
    <main class="dM_main">
        <div class="dM_content-wrapper">
            <div id="bodyContent" style="display: none;">
                <!-- Page content will be dynamically inserted here -->
            </div>
        </div>
    </main>
    <footer class="dM_footer">
        <div class="dM_left" id="message"></div>
        <div class="dM_right">by Willem Aandewiel</div>
    </footer>
</body>
</html>
